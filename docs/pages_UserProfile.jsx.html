<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>pages/UserProfile.jsx - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-Components.html">Components</a><ul class='methods'><li data-type='method'><a href="module-Components.html#~Board">Board</a></li><li data-type='method'><a href="module-Components.html#~BoardTask">BoardTask</a></li><li data-type='method'><a href="module-Components.html#~EditMenuProject">EditMenuProject</a></li><li data-type='method'><a href="module-Components.html#~Footer">Footer</a></li><li data-type='method'><a href="module-Components.html#~Header">Header</a></li><li data-type='method'><a href="module-Components.html#~Panel">Panel</a></li><li data-type='method'><a href="module-Components.html#~PanelTarea">PanelTarea</a></li><li data-type='method'><a href="module-Components.html#~TaskMenuEdit">TaskMenuEdit</a></li><li data-type='method'><a href="module-Components.html#~TeamMenu">TeamMenu</a></li></ul></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li><a href="module-Config.html">Config</a><ul class='methods'><li data-type='method'><a href="module-Config.html#~clearProject">clearProject</a></li><li data-type='method'><a href="module-Config.html#~clearTask">clearTask</a></li><li data-type='method'><a href="module-Config.html#~clearUser">clearUser</a></li><li data-type='method'><a href="module-Config.html#~setActualProjects">setActualProjects</a></li><li data-type='method'><a href="module-Config.html#~setCompletedProjects">setCompletedProjects</a></li><li data-type='method'><a href="module-Config.html#~setDoneTasks">setDoneTasks</a></li><li data-type='method'><a href="module-Config.html#~setInProgressTasks">setInProgressTasks</a></li><li data-type='method'><a href="module-Config.html#~setIsLoading">setIsLoading</a></li><li data-type='method'><a href="module-Config.html#~setLoading">setLoading</a></li><li data-type='method'><a href="module-Config.html#~setLoading">setLoading</a></li><li data-type='method'><a href="module-Config.html#~setProject">setProject</a></li><li data-type='method'><a href="module-Config.html#~setTask">setTask</a></li><li data-type='method'><a href="module-Config.html#~setToReviewTasks">setToReviewTasks</a></li><li data-type='method'><a href="module-Config.html#~setTodoTasks">setTodoTasks</a></li><li data-type='method'><a href="module-Config.html#~setUser">setUser</a></li></ul></li><li></li><li></li><li></li><li><a href="module-Contexts.html">Contexts</a></li><li></li><li><a href="module-Hooks.html">Hooks</a></li><li><a href="module-Layouts.html">Layouts</a><ul class='methods'><li data-type='method'><a href="module-Layouts.html#~LayoutAuth">LayoutAuth</a></li><li data-type='method'><a href="module-Layouts.html#~LayoutPrivate">LayoutPrivate</a></li><li data-type='method'><a href="module-Layouts.html#~LayoutPublic">LayoutPublic</a></li></ul></li><li></li><li></li><li><a href="module-Modals.html">Modals</a><ul class='methods'><li data-type='method'><a href="module-Modals.html#~ConfirmModal">ConfirmModal</a></li><li data-type='method'><a href="module-Modals.html#~FormModal">FormModal</a></li><li data-type='method'><a href="module-Modals.html#~Modal">Modal</a></li></ul></li><li></li><li></li><li><a href="module-Pages.html">Pages</a><ul class='methods'><li data-type='method'><a href="module-Pages.html#~ContactUs">ContactUs</a></li><li data-type='method'><a href="module-Pages.html#~FormUserProfile">FormUserProfile</a></li><li data-type='method'><a href="module-Pages.html#~Home">Home</a></li><li data-type='method'><a href="module-Pages.html#~Login">Login</a></li><li data-type='method'><a href="module-Pages.html#~NotFound">NotFound</a></li><li data-type='method'><a href="module-Pages.html#~ProyectInfo">ProyectInfo</a></li><li data-type='method'><a href="module-Pages.html#~Register">Register</a></li><li data-type='method'><a href="module-Pages.html#~TaskInfo">TaskInfo</a></li><li data-type='method'><a href="module-Pages.html#~UserProfile">UserProfile</a></li></ul></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li><a href="module-Router.html">Router</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">pages/UserProfile.jsx</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @module Pages
 * @category Routes
 */


import React, { useEffect, useState } from "react";
import bee from "../assets/bee.png";
import beeDark from "../assets/beedark.png";
import panelFondo from "../assets/panelFondo.png";
import Board from "../components/Board";
import { useUserStore } from "../config/userStore";
import useAxiosStore from "../hooks/useAxios";
import { useProjectsStore } from "../config/projectsStore";
import SettingsIcon from "@mui/icons-material/Settings";
import AddIcon from "@mui/icons-material/Add";
import { useTheme } from "../context/ThemeContext";
import FormModal from "../modals/FormModal.jsx";
import * as Yup from "yup";
import AddPhotoAlternateIcon from "@mui/icons-material/AddPhotoAlternate";
import { brown } from "@mui/material/colors";
import fotoCambiar from "../assets/margarita.png";

/**
 * @page
 * Componente UserProfile
 * 
 * Este componente muestra la página de perfil del usuario, incluyendo su información personal,
 * proyectos actuales y proyectos completados. También proporciona funcionalidad para editar el
 * perfil del usuario y crear nuevos proyectos.
 *
 * @component
 * @returns {JSX.Element} Página de perfil de usuario, mostrando sus proyectos actuales y los finalizados.
 */
const UserProfile = () => {
  const {
    isLoading,
    actualProjects,
    completedProjects,
    setIsLoading,
    setActualProjects,
    setCompletedProjects,
  } = useProjectsStore();

  const { user, setUser } = useUserStore();
  const { fetch: newFetch } = useAxiosStore();
  const token = localStorage.getItem("token");
  const { isDarkMode } = useTheme();
  const [modalNewProjectOpen, setmodalNewProjectOpen] = useState(false);
  const [modalEditProfileOpen, setmodalEditProfileOpen] = useState(false);
  const [selectedImage, setSelectedImage] = useState({
    src: null,
    file: null,
    name: "",
  });

  const validationSchemaNewProject = Yup.object().shape({
    name: Yup.string()
      .trim()
      .required("El campo 'Nombre proyecto' es obligatorio"),
    description: Yup.string()
      .trim()
      .required("El campo 'Descripción' es obligatorio."),
    dateIni: Yup.date()
      .required("El campo 'Fecha' es obligatorio")
      .min(new Date(), "La fecha debe ser posterior a la actual"),
  });

  const validationSchemaEditProfile = Yup.object().shape({
    name: Yup.string().trim().required("El campo 'Nombre' es obligatorio"),
    email: Yup.string()
      .trim()
      .matches(
        /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}$/,
        "El formato del email no es válido"
      )
      .required("El campo 'Email' es obligatorio"),
  });


   // Obtiene los datos del usuario actual desde la API

  async function getUser() {
    try {
      if (user) {
        const response = await newFetch(
          `${import.meta.env.VITE_BASE_API}usuarios/${user._id || user.id}`,
          "GET",
          null,
          { Authorization: `Bearer ${token}` }
        );

        if (response.error) throw new Error(response.error);

        const userData = await response.data;
        setUser(userData);
      }
    } catch (error) {
      console.error("Error al obtener los datos del usuario:", error);
    }
  }

  // Obtiene los proyectos del usuario desde la API y los categoriza como actuales o completados

  async function getProjects() {
    try {
      if (user) {
        const [adminProjects, collaboratorProjects] = await Promise.all([
          newFetch(
            import.meta.env.VITE_BASE_API +
              `tableros/administrador/${user._id || user.id}`,
            "GET",
            null,
            { Authorization: `Bearer ${token}` }
          ),
          newFetch(
            import.meta.env.VITE_BASE_API +
              `tableros/colaborador/${user._id || user.id}`,
            "GET",
            null,
            { Authorization: `Bearer ${token}` }
          ),
        ]);

        if (adminProjects.error) throw new Error(adminProjects.error);
        if (collaboratorProjects.error)
          throw new Error(collaboratorProjects.error);

        const allProjects = [
          ...adminProjects.data,
          ...collaboratorProjects.data,
        ];
        const projectPromises = allProjects.map((project) =>
          newFetch(
            import.meta.env.VITE_BASE_API + `tableros/${project._id}/actual`,
            "GET",
            null,
            { Authorization: `Bearer ${token}` }
          )
        );

        const projectStatuses = await Promise.all(projectPromises);

        const newActualProjects = [];
        const newCompletedProjects = [];

        allProjects.forEach((project, index) => {
          if (projectStatuses[index].data.actual) {
            newActualProjects.push(project);
          } else {
            newCompletedProjects.push(project);
          }
        });

        setActualProjects(newActualProjects);
        setCompletedProjects(newCompletedProjects);
      }
    } catch (error) {
      console.error("Error al cargar los proyectos", error);
    } finally {
      setIsLoading(false);
    }
  }

   //Hook de efecto para obtener los datos del usuario y los proyectos al montar el componente
   
  useEffect(() => {
    async function fetchData() {
      setIsLoading(true);
      await getUser();
      await getProjects();
    }

    if (user &amp;&amp; token) {
      fetchData();
    }
  }, [token, fetch]);

  // Maneja el cambio de la imagen de perfil

  const handleImageChange = (e) => {
    const file = e.target.files[0];
    if (file) {
      const allowedTypes = [
        "image/jpeg",
        "image/png",
        "image/jpg",
        "image/webp",
      ];
      if (!allowedTypes.includes(file.type)) {
        console.log(
          "Por favor, sube una imagen válida (JPEG, PNG, JPG o WEBP)."
        );
        return;
      }

      // Guardamos el archivo y el nombre del archivo directamente
      setSelectedImage({
        src: URL.createObjectURL(file), // Vista previa usando un objeto URL temporal
        file, // El archivo original para enviarlo con FormData
        name: file.name, // Nombre del archivo
      });
    }
  };

   // Maneja el envío del formulario de edición de perfil
  
  const handleEditProfileSubmit = async (values) => {
    try {
      if (user) {
        const formData = new FormData();
        formData.append("nombre", values.name);
        formData.append("email", values.email);

        console.log(selectedImage);

        if (selectedImage.file) {
          formData.append("fotoPerfil", selectedImage.file);
        }

        const response = await newFetch(
          `${import.meta.env.VITE_BASE_API}usuarios/${user._id || user.id}`,
          "PUT",
          formData,
          {
            Authorization: `Bearer ${token}`,
            "Content-Type": "multipart/form-data",
          }
        );

        if (!response.status === 201) {
          throw new Error("Error al actualizar el perfil");
        }

        const updatedUser = await response.data;
        setUser(updatedUser);
        console.log("Perfil actualizado exitosamente:", updatedUser);
      }
    } catch (error) {
      console.error("Error al actualizar el perfil:", error);
    } finally {
      setmodalEditProfileOpen(false);
    }
  };

  if (isLoading) {
    return &lt;p>Cargando...&lt;/p>;
  }

  return (
    &lt;div className="contenedor__usuario">
      &lt;nav className="menu__usuario">
        &lt;ul className="usuario__lista">
          &lt;li className="lista__opcion">
            &lt;a href="#" onClick={() => setmodalNewProjectOpen(true)}>
              &lt;AddIcon
                sx={{
                  "&amp;:hover": {
                    color: "#FFDE81",
                    cursor: "pointer",
                    fontSize: 28,
                  },
                }}
              />
              CREAR NUEVO PROYECTO
            &lt;/a>
          &lt;/li>
          &lt;li className="lista__opcion">
            &lt;a href="#" onClick={() => setmodalEditProfileOpen(true)}>
              &lt;SettingsIcon
                sx={{
                  "&amp;:hover": {
                    color: "#FFDE81",
                    cursor: "pointer",
                    fontSize: 28,
                  },
                }}
              />
              CONFIGURACIÓN USUARIO
            &lt;/a>
          &lt;/li>
        &lt;/ul>
      &lt;/nav>

      &lt;section className="info__usuario">
        &lt;div className="user__container">
          {/* Foto de perfil del usuario */}
          {user &amp;&amp; user.fotoPerfil ? (
            &lt;img className="images__user" src={user.fotoPerfil} alt="" />
          ) : (
            &lt;img
              className="images__user"
              src="https://cdn-icons-png.flaticon.com/512/6326/6326055.png"
              alt=""
            />
          )}

          {/* Logo abejita */}
          &lt;img
            className="images__logo"
            src={isDarkMode ? beeDark : bee}
            alt="Logo de WorkHive"
          />
        &lt;/div>

        {/* Nombre completo del usuario */}
        &lt;h1 className="usuario__nombre">{user &amp;&amp; user.nombre}&lt;/h1>
      &lt;/section>

      &lt;section className="contenedor__proyectos">
        &lt;Board
          name="PROYECTOS ACTUALES"
          type="inprogress"
          panels={actualProjects}
        />
        &lt;Board
          name="PROYECTOS FINALIZADOS"
          type="done"
          panels={completedProjects}
        />
      &lt;/section>

      &lt;FormModal
        isOpen={modalNewProjectOpen}
        onClose={() => setmodalNewProjectOpen(false)}
        initialValues={{
          name: "",
          dateIni: "",
          dateEnd: "",
          description: "",
        }}
        validationSchema={validationSchemaNewProject}
        onSubmit={async (values) => {
          try {
            const body = {
              nombre: values.name,
              descripcion: values.description,
              fechaInicio: values.dateIni || null,
              fechaFin: values.dateEnd || null,
              administrador: user.id,
              colaboradores: [],
            };

            const response = await fetch(
              import.meta.env.VITE_BASE_API + "tableros",
              "POST",
              JSON.stringify(body),
              {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              }
            );

            const data = await response.data;

            if (!response.status === 201) {
              throw new Error(data.message || "Error al crear el tablero");
            }

            console.log("Tablero creado exitosamente:", data);
            getProjects();
          } catch (error) {
            console.error("Error al crear el proyecto:", error);
          } finally {
            setmodalNewProjectOpen(false);
          }
        }}
        title="Añadir proyecto"
      >
        {({ values, handleChange, handleBlur, errors, touched }) => (
          &lt;>
            &lt;label htmlFor="name" className="formulario__label">
              Nombre proyecto
              &lt;input
                type="text"
                name="name"
                value={values.name}
                onChange={handleChange}
                onBlur={handleBlur}
                className="formulario__input"
              />
              {errors.name &amp;&amp; touched.name &amp;&amp; (
                &lt;p className="formulario__error">* {errors.name}&lt;/p>
              )}
            &lt;/label>

            &lt;label htmlFor="dateIni" className="formulario__label">
              Fecha inicio
              &lt;input
                type="date"
                name="dateIni"
                value={values.dateIni}
                onChange={handleChange}
                onBlur={handleBlur}
                className="formulario__input"
              />
              {errors.dateIni &amp;&amp; touched.dateIni &amp;&amp; (
                &lt;p className="formulario__error">* {errors.dateIni}&lt;/p>
              )}
            &lt;/label>

            &lt;label htmlFor="dateEnd" className="formulario__label">
              Fecha fin
              &lt;input
                type="date"
                name="dateEnd"
                value={values.dateEnd}
                onChange={handleChange}
                onBlur={handleBlur}
                className="formulario__input"
              />
              {errors.dateEnd &amp;&amp; touched.dateEnd &amp;&amp; (
                &lt;p className="formulario__error">* {errors.dateEnd}&lt;/p>
              )}
            &lt;/label>

            &lt;label htmlFor="description" className="formulario__label">
              Descripción
              &lt;textarea
                name="description"
                value={values.description}
                onChange={handleChange}
                onBlur={handleBlur}
                className="formulario__input"
              />
              {errors.description &amp;&amp; touched.description &amp;&amp; (
                &lt;p className="formulario__error">* {errors.description}&lt;/p>
              )}
            &lt;/label>
          &lt;/>
        )}
      &lt;/FormModal>

      &lt;FormModal
        isOpen={modalEditProfileOpen}
        onClose={() => setmodalEditProfileOpen(false)}
        initialValues={{
          name: user?.nombre || "",
          email: user?.email || "",
        }}
        validationSchema={validationSchemaEditProfile}
        onSubmit={handleEditProfileSubmit}
        title="Editar perfil"
      >
        {({ values, handleChange, handleBlur, errors, touched }) => (
          &lt;>
            &lt;div className="formulario-perfil">
              &lt;div className="formulario-perfil__foto">
                &lt;img
                  src={selectedImage.src || user.fotoPerfil || fotoCambiar}
                  alt="Foto de perfil"
                  className="foto__imagen-redonda"
                />

                &lt;input
                  type="file"
                  id="fileInput"
                  className="foto__input-fichero"
                  onChange={handleImageChange}
                />

                &lt;label htmlFor="fileInput" className="foto__boton">
                  &lt;AddPhotoAlternateIcon sx={{ color: brown[400] }} />
                &lt;/label>
              &lt;/div>
            &lt;/div>

            &lt;label htmlFor="name" className="formulario__label">
              Nombre
              &lt;input
                type="text"
                name="name"
                value={values.name}
                onChange={handleChange}
                onBlur={handleBlur}
                className="formulario__input"
              />
              {errors.name &amp;&amp; touched.name &amp;&amp; (
                &lt;p className="formulario__error">* {errors.name}&lt;/p>
              )}
            &lt;/label>

            &lt;label htmlFor="email" className="formulario__label">
              Email
              &lt;input
                type="text"
                name="email"
                value={values.email}
                onChange={handleChange}
                onBlur={handleBlur}
                className="formulario__input"
              />
              {errors.email &amp;&amp; touched.email &amp;&amp; (
                &lt;p className="formulario__error">* {errors.email}&lt;/p>
              )}
            &lt;/label>
          &lt;/>
        )}
      &lt;/FormModal>
    &lt;/div>
  );
};

export default UserProfile;
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.4</a> on Mon Jan 27 2025 10:51:59 GMT+0100 (hora estándar de Europa central) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
